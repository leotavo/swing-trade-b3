# Release: v0.4.0 — Issue #4 concluída (Conector B3 histórico)

- Status: publicado
- Data: 2025-09-01
- Escopo: Implementar conector API B3 (histórico) — Milestone 2, Issue #4
- PR: #110 (branch `feat/issue4-b3-connector`)

## Resumo

- Conector histórico (brapi.dev) com cliente HTTP robusto (timeout, retries com backoff + jitter, User-Agent).
- Parser para OHLCV diário padronizado: `date` (UTC), `symbol` (str), `open/high/low/close` (float64), `volume` (int64), ordenação e dedupe `(symbol,date)`.
- Persistência raw idempotente por ano em `data/raw/{symbol}/YYYY.(csv|parquet)`; Parquet com compressão opcional (`snappy`, `zstd`).
- CLI `fetch` com múltiplos símbolos (`-s` e/ou `--symbols-file`), throttle (`--throttle`), `--force-max`, `--format`, `--compression` e `--json-summary`.
- Resumo JSON opcional com metadados de execução e métricas HTTP por símbolo.
- Documentação do contrato do conector e exemplos atualizados no README.

## Evidências

- Testes: `pytest -q` → 7 passed, 1 warning (pandas deprecation).
- Execução exemplo: `python -m app fetch -s PETR4 VALE3 --start 2023-01-01 --end 2024-01-01 --format parquet --compression snappy --throttle 0.2 --json-summary out/summary.json`.
- Arquivo de exemplo do JSON: `docs/summary-example.json`.

## Arquivos principais

- Código
  - `src/app/connector/b3.py` — HTTP + parser + fetch
  - `src/app/persistence.py` — persistência raw CSV/Parquet
  - `src/app/__main__.py` — CLI `fetch`
  - `src/app/throttle.py` — throttle simples

- Testes
  - `tests/test_connector_parser.py`
  - `tests/test_persistence_parquet.py`
  - `tests/test_throttle.py`

- Documentação
  - `docs/data-connector-spec.md`
  - `README.md` (seção CLI e JSON)
  - `docs/M2_subissues_atomic.md` (critérios Issue #4 marcados)

## Notas

- Range relativo ao “hoje”: `_choose_range(start,end)` escolhe a menor janela; fallback para `max` quando necessário.
- Evitar rate-limit: usar `--throttle` e observar `RateLimitError` (429) com retries/backoff.
- CSV é padrão; Parquet com compressão recomendado para volume maior.
